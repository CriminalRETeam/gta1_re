#include "cutscene.h"
#include "game.h"
#include "graphics.h"
#include "sound.h"

#include <mgraph.h>
#include <smack.h>
#include <windows.h>

// GLOBAL: GTA 0x004a73dc
int g_Count_mission_cutscene_fonts[] = { 2, 4, 3, 3, 2, 4 };

// GLOBAL: GTA 0x004af540
const char *g_Cut_font_names[6][4] = {
    { "cut00", "cut01", },
    { "cut10", "cut11", "cut12", "cut13", },
    { "cut20", "cut21", "cut22", },
    { "cut30", "cut31", "cut32", },
    { "cut40", "cut41", },
    { "cut50", "cut51", "cut52", "cut53", },
};

// GLOBAL: GTA 0x004af5a0
const char *g_Cut_font_text_names[6][4] = {
    { "cut00t", "cut01t", },
    { "cut10t", "cut11t", "cut12t", "cut13t", },
    { "cut20t", "cut21t", "cut22t", },
    { "cut30t", "cut31t", "cut32t", },
    { "cut40t", "cut41t", },
    { "cut50t", "cut51t", "cut52t", "cut53t", },
};

// GLOBAL: GTA 0x005106dc
tFont *g_City_cut_fonts[4];

// GLOBAL: GTA 0x004af524
const char *g_Cut_backscreen_paths[6] = {
    "..\\gtadata\\cut0",
    "..\\gtadata\\cut1",
    "..\\gtadata\\cut2",
    "..\\gtadata\\cut3",
    "..\\gtadata\\cut4",
    "..\\gtadata\\cut5",
};

// GLOBAL: GTA 0x004a73f8
const char g_Cut_scene_animation_data[6][5][193] = {
    {
        "777777771110801111026646330001110823486630205236655017333071820442442000000000322441248888211118882444288483076324888444448873660358202888870332488641111110272444266633077772222222222222222222",
        "444444444411333111144444444441111111111111111111111111111111111111111111444444444444444444444133333333333333333333333333333333333333333333333333333333333311121111111111144444444444444444444444",
        "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        "000000000000000000000000000000111111111111111111111111111111111111111111111111222222222222222222222222222222222222222333333333333333333333333333333333333333333333333333333333333333333333333333",
    },
    {
        "777777777631645533626613315688356833366666665537133463253314853163144584335777777773245438354133635351467777777777777777777777777777777777777777777777777777777777777777777777777777777777777777",
        "111133331222222222222222222222222222222322212121111111111122121122222232222221121211111111212121222233111122222222244442222222222222222222222222222222222222222222222222222222222222222222222222",
        "111121221222222222222222222222222222222222212121111111111122121122222222222221121211111111212121222222111122222222222222222222222222222222222222222222222222222222222222222222222222222222222222",
        "553342112233445566112233445566112233445566553344112233445566555522334455661155533344221122334455661122334455661122334456611223344000000000000000000000000000000000000000000000000000000000000000",
        "000000000000111111111111111111111111111111111112222222222222222222222222222222222223333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333",
    },
    {
        "881111111111143513237334531732448823276623515327442811111143537246215323237376248555535573737721111124466445335553831232111111246643558555343573442222221111111111111111111111111111111111111111",
        "333332222222112222222222112222222222221112221112222222222222222222232222222211221112233333333333332222222112222222222222222222222222222222211333333333332222223333333333333333333333333333333333",
        "111111143333333331113333222222122222211111111434343434343434341111111322222222224242433333333331311133312144442111111144444441414221322223331111333311233333333333332222222222222222222222222222",
        "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        "000000000000011111111111111111111111111111111111111111111122222222222222222222222222222222222222222233333333333333333333333333444444444444444444444444444444444444444444444444444444444444444444",
    },
    {
        "666631133028334428:999::40775888430344445588556823448::877700589:8468311326488486135388147335822444713588113544111337741731113311112531445813585281445335744431112444444444444444444444444444444",
        "111554455535555555544411115555555555511111445555555554445555555544455444536666666445666666666666545666222222224444555556666666666456666666666666654666666666666666666666666666666666666666666666",
        "334435522112233222332211123443355113322155444331123443555121122334435544331221213344355221122332223322111234433551133221554443311234435551211223344355443312212155443123455555555555555555555555",
        "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        "000000000000000000000000001111111111111111111111111111111111122222222222222222222222222222222222222222222222222222222222222222233333333333333333333333333333333333333333333333333333333333333333",
    },
    {
        "0000003685841557669466131448:43723735435321074753696485174451771777323:77859667777182::43356668327297785517729933377847:437732175547333333333333333333333333333333333333333333333333333333333333",
        "333333111111111111333333333333333333333333211111111111111111111111111111111111111111113333333333333333333333333111111133333333333333333333333333333333333333333333333333333333333333333333333333",
        "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        "000000111111111111111111111111111111111111112222222222222222222222222233333333333333333333333333333333333333333333444444444444444444444444444444444444444444444444444444444444444444444444444444",
    },
    {
        "333333222222515444441552333361155126152652656161165613451665223335111351366154156212123326525256162635262645333336441152233333333316426513225645151261523333333333000000000000000000000000000000",
        "000000000000000000001100000000001100001100000000000000000011000000000000000000000000000011000000000011000000000000000011111111000000000000000000000000000000000000000000000000000000000000000000",
        "112200001100112200001111001122002211220011220000111100001122001100112200001100001122000011000011220000110011220000112222222222222222222222220000112200111100000000000000000000000000000000000000",
        "112233445566554433221122334455665544332211223344556655443322112233445566554433221122334455665544332211223344556655443322112233445566554433221122334455665544332211223344000000000000000000000000",
        "000000000000000000000000000011111111111111111111111111111111111112222222222222222222222233333333333333333333333333333333333333333344444444444444444444444444444444444444000000000000000000000000",
    }
};

// GLOBAL: GTA 0x004a8a98
int g_Cut_scene_animation_positions[6][4][2] = {
    {
        { 53, 69, },
        { 59, 47, },
    }, {
        {395, 146,},
        {366, 82,},
        {228, 10,},
        {275, 277,},
    }, {
        { 124, 122, },
        { 126, 88, },
        { 535, 66, },
    }, {
        { 381, 84, },
        { 376, 14, },
        { 164, 191, },
    }, {
        { 354, 71, },
        { 358, 5, },
    },
    {
        {357, 88,},
        {357, 49,},
        {377, 360,},
        {100, 285,},
    },
};

const char *g_Cut_text_names[6][4] = {
    { "cut00t", "cut01t", },
    { "cut10t", "cut11t", "cut12t", "cut13t", },
    { "cut20t", "cut21t", "cut22t" },
    { "cut30t", "cut31t", "cut32t" },
    { "cut40t", "cut41t" },
    { "cut50t", "cut51t", "cut52t", "cut53t", },
};


// GLOBAL: GTA 0x00511930
tPixelmap g_Cutscreen_pixelmap;

// FUNCTION: GTA 0x00414d40
void ApplySmackPalette(unsigned char *palette) {
    palette_t mgl_palette[256];
    for (int i = 0; i < 256; i++) {
        mgl_palette[i].blue = palette[3 * i + 2];
        mgl_palette[i].green = palette[3 * i + 1];
        mgl_palette[i].red = palette[3 * i + 0];
    }
    MGL_setPalette(g_MGLDC_Screen, mgl_palette, GTA_ASIZE(mgl_palette), 0);
    MGL_realizePalette(g_MGLDC_Screen, GTA_ASIZE(mgl_palette), 0, 0);
}

// FUNCTION: GTA 0x0044b160
void PlayDMAIntro() {

    ProcessEvents();
    if (StartMilesSoundForIntro()) {
        SmackSoundUseMSS(g_Miles_device);
    }
    HSMACK smack = SmackOpen("..\\gtadata\\movie.smk", SMACKTRACKS, 0xffffffff);
    if (smack != NULL) {
        ConfigureDisplay2(-2);
        if (!g_No_cutscene_video_mode) {
            SmackToBuffer(smack, 0, 20, g_Memory_DC->mi.bytesPerLine, g_Memory_DC->mi.yRes, g_Memory_DC->surface, 0);
            for (int frame = 0; frame < smack->Frames; frame++) {
                if (smack->NewPalette) {
                    ApplySmackPalette(smack->Palette);
                }
                SmackDoFrame(smack);
                while (SmackToBufferRect(smack, 0)) {
                    int xl = smack->LastRectx;
                    int yl = smack->LastRecty;
                    int xr = smack->LastRectx + smack->LastRectw;
                    int yr = smack->LastRecty + smack->LastRecth;
                    MGL_stretchBltCoord(g_MGLDC_Screen, g_Memory_DC,
                        xl, yl, xr, yr,
                        2 * xl, 2 * yl, 2 * xr, 2 * yr);
                }
                if (smack->Frames) {
                    SmackNextFrame(smack);
                }
                while (SmackWait(smack)) {
                }
                int key_event = KeyboardEvent();
                if (key_event != 0 && key_event != eScancode_LAlt) {
                    break;
                }
            }
            memset(smack->Palette, 0, sizeof(smack->Palette));
            MGL_clearDevice();
            MGL_bitBltCoord(g_MGLDC_Screen, g_Memory_DC, 0, 0, 640, 480, 0, 0, 0);
            ApplySmackPalette(smack->Palette);
        }
        SmackClose(smack);
    }
    StopMilesForIntro();
}

// FUNCTION: GTA 0x0042d810
void LoadCutscenePixelmap(const char *path) {
    LoadPixelmap(&g_Cutscreen_pixelmap, path, 1);
}
